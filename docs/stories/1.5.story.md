# Story 1.5: Authentication - Supabase Auth with Microsoft Entra ID OAuth

## 1. Context

The original auth strategy relied on Cloudflare Access (Zero Trust) to intercept all requests and inject identity headers (`cf-access-authenticated-user-email`). However, Cloudflare Zero Trust requires a credit card even on the free tier, making it impractical for this project. We pivot to **Supabase Auth** with **Microsoft Entra ID** as the OAuth provider, keeping the same security guarantees: only `@wpd.fr` users can access the application, and unauthenticated users see zero data.

This replaces the auth layer from Story 1.4 (`hooks.server.ts` reading CF Access headers) with a cookie-based session flow managed by `@supabase/ssr`.

## 2. User Story

As a **wpd.fr employee**,
I want to **log in with my Microsoft work account**,
So that **I can securely access the wind farm dashboard without additional credentials**.

## 3. Acceptance Criteria

### Login Flow

- [ ] **AC1**: Unauthenticated users hitting `/dashboard` are **automatically redirected** to Microsoft OAuth (no intermediate login page) — seamless, like Cloudflare Access
- [ ] **AC2**: After successful Microsoft login, user is redirected to `/dashboard`
- [ ] **AC3**: A `/auth/callback` route handles the OAuth callback and exchanges the code for a session
- [ ] **AC4**: A minimal `/login` page exists as fallback for error display and manual retry (user rarely sees it)

### Session Management

- [ ] **AC5**: `hooks.server.ts` creates a Supabase server client on every request using `@supabase/ssr` cookie helpers
- [ ] **AC6**: The authenticated user session is available via `event.locals.user` (same interface as before: `{ email, name }`)
- [ ] **AC7**: Session persists across page navigations via secure HTTP-only cookies
- [ ] **AC8**: A logout action clears the Supabase session and redirects to `/login`

### Route Protection

- [ ] **AC9**: Unauthenticated requests to `/dashboard` trigger automatic OAuth redirect (transparent to user)
- [ ] **AC10**: Unauthenticated requests to `/api/*` return 401 JSON response
- [ ] **AC11**: The `/login` page is accessible without authentication (fallback/error page)
- [ ] **AC12**: Authenticated users visiting `/login` are redirected to `/dashboard`

### Domain Restriction

- [ ] **AC13**: Only users with `@wpd.fr` email addresses can log in
- [ ] **AC14**: Non-wpd.fr users who somehow authenticate see an error message and are signed out

### Local Development

- [ ] **AC15**: `npm run dev` works with mock authentication (no Microsoft login required)
- [ ] **AC16**: Dev mock user is configurable via `DEV_MOCK_EMAIL` environment variable
- [ ] **AC17**: The `dev` flag from `$app/environment` controls mock vs real auth (same pattern as current)

### Backward Compatibility

- [ ] **AC18**: `locals.user` keeps the same `{ email: string, name: string } | null` interface
- [ ] **AC19**: All existing dashboard tabs, API routes, and data loading continue to work unchanged
- [ ] **AC20**: No changes to Supabase database queries or data layer

## 4. Technical Notes

### Package Addition
- Add `@supabase/ssr` — the official Supabase package for server-side auth in SvelteKit (replaces deprecated `@supabase/auth-helpers-sveltekit`)

### Supabase Dashboard Configuration (Manual)
- Enable Microsoft provider in Supabase > Authentication > Providers > Azure
- Configure with the existing Azure App Registration credentials (Client ID, Secret, Tenant ID)
- Set redirect URL to `<SUPABASE_URL>/auth/v1/callback`
- Add the Supabase callback URL to the Azure App Registration redirect URIs

### Architecture Pattern (`@supabase/ssr`)
- **Server client**: Created in `hooks.server.ts` using `createServerClient()` with cookie get/set/remove helpers from `event.cookies`
- **Browser client**: Created in a layout load function using `createBrowserClient()` for client-side auth state
- **Session sync**: `hooks.server.ts` calls `supabase.auth.getUser()` on each request to validate the session and populate `locals.user`

### Key Files to Modify/Create
- `src/hooks.server.ts` — Rewrite: Supabase server client + session check (replaces CF header reading)
- `src/lib/server/supabase.ts` — Update: separate auth client creation from data client
- `src/routes/login/+page.svelte` — New: login page with Microsoft button
- `src/routes/login/+page.server.ts` — New: redirect if already authenticated
- `src/routes/auth/callback/+server.ts` — New: OAuth callback handler
- `src/routes/dashboard/+layout.server.ts` — New or update: auth guard for dashboard routes
- `src/app.d.ts` — Update: add `supabase` and `session` to Locals interface
- `package.json` — Update: add `@supabase/ssr` dependency

### Environment Variables
- Existing: `SUPABASE_URL`, `SUPABASE_ANON_KEY` (already configured in Cloudflare Pages)
- Existing: `DEV_MOCK_EMAIL` (local dev only)
- New: None required — Microsoft OAuth is configured in Supabase dashboard, not in env vars

## 5. Tasks

- [x] **Task 1: Install `@supabase/ssr` and update types**
  - [x] Add `@supabase/ssr` to dependencies
  - [x] Update `src/app.d.ts` to include Supabase client and session in Locals

- [x] **Task 2: Rewrite `hooks.server.ts`**
  - [x] Create Supabase server client with cookie helpers on each request
  - [x] Call `getUser()` to validate session
  - [x] Populate `locals.user` from session (or null)
  - [x] Preserve dev mock logic (when `dev === true`)
  - [x] Auto-redirect unauthenticated `/dashboard` requests to `/login` (which auto-triggers OAuth)
  - [x] Return 401 for unauthenticated `/api/*` requests
  - [x] Enforce `@wpd.fr` domain restriction

- [x] **Task 3: Create login fallback page**
  - [x] Create `/login/+page.svelte` — auto-triggers OAuth on mount + error display + "Réessayer" button
  - [x] Create `/login/+page.server.ts` that redirects authenticated users to `/dashboard`
  - [x] "Réessayer" button triggers `supabase.auth.signInWithOAuth({ provider: 'azure' })` for manual retry

- [x] **Task 4: Create OAuth callback route**
  - [x] Create `/auth/callback/+server.ts`
  - [x] Exchange auth code for session
  - [x] Redirect to `/dashboard` on success, `/login?error=callback` on failure

- [x] **Task 5: Add logout functionality**
  - [x] Add logout API route (`/api/auth/logout`)
  - [x] Clear Supabase session via `signOut()`
  - [x] Redirect to `/login`
  - [x] Added logout button in sidebar user card

- [x] **Task 6: Update Supabase client architecture**
  - [x] Verified: data client (`src/lib/server/supabase.ts`) coexists with auth client (hooks) — no refactor needed
  - [x] Data queries continue to use the existing singleton pattern unchanged

- [x] **Task 7: Supabase Dashboard Config (Manual - documented)**
  - [x] Document steps to enable Microsoft provider in Supabase
  - [x] Document Azure App Registration redirect URI update
  - [x] Rewrote `RESOURCES/cloudflare-entraid-deployment.md` for new Supabase Auth flow

- [x] **Task 8: Update tech-stack.md**
  - [x] Replace "Cloudflare Access (Zero Trust)" with "Supabase Auth + Microsoft Entra ID OAuth"
  - [x] Add `@supabase/ssr` to key libraries

- [ ] **Task 9: Testing & Verification**
  - [ ] Verify dev mock auth still works (`npm run dev`)
  - [ ] Verify unauthenticated users are redirected to `/login`
  - [ ] Verify `/api/*` returns 401 for unauthenticated requests
  - [ ] Verify Microsoft OAuth login flow end-to-end (requires Supabase config)
  - [ ] Verify all dashboard tabs load correctly after auth
  - [ ] Verify logout clears session

## 6. Risk & Compatibility

- **Primary Risk**: Supabase Auth session cookies may behave differently on Cloudflare Workers runtime
- **Mitigation**: `@supabase/ssr` is designed for edge runtimes; test on Cloudflare Pages early
- **Rollback**: Revert to CF Access header approach if Supabase Auth proves incompatible (just revert hooks.server.ts)
- **Breaking changes**: None — `locals.user` interface stays identical, all downstream code unchanged

## 7. Out of Scope

- Role-based access control (all @wpd.fr users have the same permissions)
- Supabase RLS (Row Level Security) — data access is server-side only
- Email/password login fallback
- Multi-factor authentication

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6

### File List
- `package.json` - Updated: added `@supabase/ssr` dependency
- `package-lock.json` - Updated: lockfile
- `src/app.d.ts` - Updated: added `supabase` and `safeGetSession` to Locals interface
- `src/hooks.server.ts` - Rewritten: Supabase Auth server client + session validation + route protection
- `src/routes/login/+page.server.ts` - New: login page server loader (redirects if authenticated, passes Supabase creds)
- `src/routes/login/+page.svelte` - New: auto-trigger OAuth on mount, error fallback with retry
- `src/routes/auth/callback/+server.ts` - New: OAuth callback handler (exchanges code for session)
- `src/routes/api/auth/logout/+server.ts` - New: logout endpoint (signOut + redirect)
- `src/routes/dashboard/+page.svelte` - Updated: added logout button in sidebar user card
- `docs/architecture/tech-stack.md` - Updated: replaced Cloudflare Access with Supabase Auth
- `RESOURCES/cloudflare-entraid-deployment.md` - Rewritten: new deployment guide for Supabase Auth flow

### Debug Log References
- Build blocked by Windows group policy (`spawn UNKNOWN`) — environment issue, not code
- Task 9 (testing) requires Supabase Azure provider config + Cloudflare deploy to validate

### Change Log
- Tasks 1-8 implemented
- Task 9 (testing) pending: requires Supabase dashboard config (Phase A+B in deployment guide) + Cloudflare deploy

### Completion Notes
- Auth architecture replaced from Cloudflare Access (Zero Trust) to Supabase Auth + Microsoft OAuth
- `locals.user` interface unchanged — zero impact on existing dashboard/API code
- Dev mock preserved — `npm run dev` works without Microsoft login
- Login page auto-triggers OAuth (seamless UX, no button in normal flow)
