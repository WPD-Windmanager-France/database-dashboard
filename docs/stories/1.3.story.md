# Story 1.3: Database Integration

## Status
Ready for Review

## Story
**As a** Developer,
**I want** the API to securely connect to the Supabase (PostgreSQL) database,
**so that** it can perform data operations (read/write).

---

## Acceptance Criteria

*   **AC1:** A modern, edge-compatible PostgreSQL client library for TypeScript is added as a dependency.
*   **AC2:** The Supabase database connection string is stored securely as a Cloudflare Worker secret.
*   **AC3:** A data access layer or module is created to manage the database connection, ensuring efficient handling in the serverless environment.
*   **AC4:** A test endpoint (e.g., `GET /db-status`) is created to verify the connection to the database is successful.
*   **AC5:** The API can successfully execute a simple `SELECT` query on a test table.
*   **AC6:** All database interactions are wrapped in try/catch blocks to handle potential connection or query errors gracefully.

---

## Tasks / Subtasks

- [x] **Task 1: Install database dependencies** (AC1)
  - [x] Install `@supabase/supabase-js` for Supabase REST API access (Edge-compatible)
  - [x] Verify dependencies work with Cloudflare Workers runtime

- [x] **Task 2: Configure database environment** (AC2)
  - [x] Create `src/config/database.ts` for database configuration
  - [x] Define environment variables in `wrangler.toml`: `SUPABASE_URL`, `SUPABASE_ANON_KEY`
  - [x] Document required secrets for production

- [x] **Task 3: Create data access layer** (AC3, AC6)
  - [x] Create `src/lib/supabase.ts` with Supabase client factory
  - [x] Implement error handling wrapper for database operations
  - [x] Ensure client is created per-request (serverless best practice)

- [x] **Task 4: Create /db-status endpoint** (AC4)
  - [x] Create `src/routes/db.ts` with database routes
  - [x] Implement `GET /db/status` endpoint to test connection
  - [x] Return connection status and basic info

- [x] **Task 5: Implement test query** (AC5)
  - [x] Create `GET /db/tables` endpoint listing available tables
  - [x] Create `GET /db/query-test` endpoint for SELECT query test
  - [x] Verify error handling for failed queries

- [x] **Task 6: Update documentation**
  - [x] Update `backend/README.md` with database setup instructions
  - [x] Document Supabase project requirements

---

## Dev Notes

### Cloudflare Workers + Supabase
- `@supabase/supabase-js` uses REST API (PostgREST) - fully Edge-compatible
- No TCP connections needed (unlike node-postgres)
- Client should be created per-request in serverless environment

### Environment Variables
```toml
[vars]
SUPABASE_URL = "https://xxx.supabase.co"

# Secrets (via wrangler secret put)
# SUPABASE_ANON_KEY
# SUPABASE_SERVICE_ROLE_KEY (for admin operations)
```

### Supabase Client Pattern
```typescript
import { createClient } from '@supabase/supabase-js'

export function getSupabaseClient(env: Env) {
  return createClient(env.SUPABASE_URL, env.SUPABASE_ANON_KEY)
}
```

---

## Testing

- **Manual Testing**: Test endpoints via curl during local development
- **Validation**: Verify connection to actual Supabase instance

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-03 | 1.0 | Initial story creation | PM |
| 2026-02-04 | 1.1 | Added detailed tasks and dev notes | Dev Agent |
| 2026-02-04 | 1.2 | All tasks completed, ready for review | Dev Agent |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
- `@supabase/supabase-js` utilisé au lieu de `node-postgres` (incompatible Edge runtime)
- Client Supabase créé per-request (serverless best practice)
- Helper `dbOperation()` pour wrapper les erreurs de façon consistante

### Completion Notes List
- Task 1: `@supabase/supabase-js` installé, Edge-compatible via REST API
- Task 2: Config database avec validation des variables requises
- Task 3: Client factory + admin client + error wrapper créés
- Task 4: Endpoint `/db/status` avec health check et response time
- Task 5: Endpoints `/db/tables` et `/db/query-test` avec gestion d'erreurs
- Task 6: README mis à jour avec section Database complète

### File List
- `backend/src/config/database.ts` - Configuration Supabase
- `backend/src/lib/supabase.ts` - Client factory et helpers
- `backend/src/routes/db.ts` - Routes database (/db/*)
- `backend/src/config/auth.ts` - Env étendu avec Supabase vars
- `backend/src/index.ts` - Import db routes
- `backend/src/dev-server.ts` - Supabase env pour dev local
- `backend/wrangler.toml` - Variables documentées
- `backend/README.md` - Documentation mise à jour
- `backend/package.json` - Dépendance @supabase/supabase-js

---

## QA Results
*To be filled after implementation*
