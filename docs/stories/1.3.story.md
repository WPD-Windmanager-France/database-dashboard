# Story 1.3: Farm Management Application - Full CRUD with Dashboard

## 1. Context

Create a comprehensive farm management application with full CRUD capabilities, replicating the Taipy legacy app's functionality and superior aesthetics. The application features a tabbed interface for organizing farm data (Dashboard, General Info, Referents, Services, Contracts, Location) with inline editing capabilities.

## 2. Acceptance Criteria

### Layout & Navigation

- [ ] **AC1**: Fixed sidebar (300px) with gradient background displays farm selector (radio-style cards)
- [ ] **AC2**: "Database Documentation" button at bottom of sidebar
- [ ] **AC3**: Main content area with tabbed interface (6 tabs: Dashboard, General, Referents, Services, Contracts, Location)
- [ ] **AC4**: Responsive layout collapses to single column on mobile

### Tab 1: Dashboard (Visualization)

- [ ] **AC5**: Performance chart showing Actual vs Target by year (line chart)
- [ ] **AC6**: Stat cards displaying: Turbine Count, Total Power Capacity, Farm Status
- [ ] **AC7**: Data fetched from `get_farm_performance_data()` and `get_farm_technical_details()`

### Tab 2: General (Editable)

- [ ] **AC8**: Display fields: SPV, Project Name, Farm Code (read-only), Farm Type, Farm Status
- [ ] **AC9**: Inline editing with "Edit" button → Input field → Save/Cancel actions
- [ ] **AC10**: Updates persist to database via API routes

### Tab 3: Referents (Editable)

- [ ] **AC11**: Display key roles: Technical Manager, KAM, Head of Tech, Electrical Manager, Field Crew, Asset Manager
- [ ] **AC12**: Inline editing with person selector dropdown
- [ ] **AC13**: "Add New Person" functionality within edit mode

### Tab 4: Services

- [ ] **AC14**: Display service providers: OM Main, WTG Service, Grid Operator, Energy Trader, etc.
- [ ] **AC15**: Read-only display (editing to be added in future story)

### Tab 5: Contracts & Admin

- [ ] **AC16**: Display administration data: SIRET, VAT, Legal Rep, Head Office
- [ ] **AC17**: Display contracts: O&M Contract, TCMA Contract details
- [ ] **AC18**: Display financial guarantee, electrical delegation, environmental installation

### Tab 6: Location (Editable)

- [ ] **AC19**: Display geographic location: Country, Region, Department, Municipality
- [ ] **AC20**: Display distances: Arras distance, Vertou duration, tolls
- [ ] **AC21**: Inline editing for all location fields

### Aesthetics (Taipy-Inspired)

- [ ] **AC22**: Primary color blue `#1565c0` for accents, borders, buttons
- [ ] **AC23**: Gradient background for sidebar: `linear-gradient(180deg, #f8f9fa 0%, #e9ecef 100%)`
- [ ] **AC24**: Card-based layout with `bg-gray-50`, `8px` border-radius, subtle shadows
- [ ] **AC25**: Clean typography hierarchy: section titles, muted labels (#6c757d), bold values

### Security

- [x] **AC26**: Production guard in `hooks.server.ts` blocks `/dashboard` and `/api` routes if user is not authenticated
- [ ] **AC27**: Verify unauthenticated users receive 401 on all data routes (no data leakage)

### API & Data Layer

- [ ] **AC28**: Server-side loaders in `+page.server.ts` fetch all farm data
- [ ] **AC29**: API routes implement CRUD operations: `GET/PATCH /api/farms/[uuid]`, `PUT /api/farms/[uuid]/referents/[role]`
- [ ] **AC30**: Database query layer in `src/lib/server/db/` with TypeScript interfaces

## 3. Technical Notes

- Replicate Taipy app's inline editing pattern: toggle between display/edit modes
- Use Tailwind CSS for styling with custom CSS variables for Taipy color palette
- Extract SQL queries from Python `database.py` functions and adapt for Supabase
- Create reusable components: `FarmCard.svelte`, `EditableField.svelte`, `FarmSelector.svelte`
- Performance data visualization using Chart.js or similar lightweight library
- All database interactions must use SSR (server-side rendering) to keep credentials private

## 4. Tasks

- [x] **Task 1: Project Setup & Styling**
  - [x] Add Taipy color palette to `app.css` (CSS variables)
  - [x] Create global styles for cards, gradients, scrollbars
  - [x] Set up TypeScript interfaces in `src/lib/types/farm.ts`

- [x] **Task 2: Database Query Layer**
  - [x] Create `src/lib/server/db/farms.ts` with query functions
  - [x] Create `src/lib/server/db/referents.ts` for referent operations
  - [x] Port SQL logic from Python `database.py` to TypeScript/Supabase

- [x] **Task 3: Shared UI Components**
  - [x] Build `FarmCard.svelte` (reusable card component)
  - [x] Build `EditableField.svelte` (inline editing component)
  - [x] Build `FarmSelector.svelte` (radio-style farm selector)

- [x] **Task 4: Dashboard Route - Layout & Sidebar**
  - [x] Create `src/routes/dashboard/+page.server.ts` with data loaders
  - [x] Create `src/routes/dashboard/+page.svelte` with 2-column layout
  - [x] Implement sidebar with farm selector and logout button

- [x] **Task 5: Tab 1 - Dashboard (Visualization)**
  - [x] Fetch performance data in server loader
  - [x] Create performance chart component (Actual vs Target)
  - [x] Create stat cards for turbine count, power, status

- [x] **Task 6: Tab 2 - General Info (Editable)**
  - [x] Display general info fields with `EditableField` components
  - [x] Implement inline editing for SPV, Project, Farm Type
  - [x] Connect to PATCH API route for updates

- [x] **Task 7: Tab 3 - Referents (Editable)**
  - [x] Display referent roles in 2-column layout
  - [x] Implement inline editing with person selector
  - [x] Add "New Person" creation functionality

- [x] **Task 8: Tab 4 - Services (Read-Only)**
  - [x] Display service providers in card layout
  - [x] Fetch company roles data in server loader

- [x] **Task 9: Tab 5 - Contracts & Admin (Read-Only)**
  - [x] Display administration data
  - [x] Display O&M and TCMA contract details
  - [x] Display financial, electrical, environmental sections

- [x] **Task 10: Tab 6 - Location (Editable)**
  - [x] Display location fields with `EditableField` components
  - [x] Implement inline editing for all location data
  - [x] Connect to PATCH API route for updates

- [x] **Task 11: API Routes**
  - [x] Create `GET/PATCH /api/farms/[uuid]/+server.ts`
  - [x] Create `PUT /api/farms/[uuid]/referents/+server.ts`
  - [x] Add Zod validation for all mutations

- [ ] **Task 12: Testing & Verification**
  - [ ] Test all CRUD operations (create, read, update for each tab)
  - [ ] Verify HMR works (changes reflect immediately)
  - [ ] Test responsive layout on mobile/tablet
  - [ ] Verify Taipy aesthetics match design spec

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6

### File List
- `src/app.css` - Updated: Taipy color palette CSS variables + global styles
- `src/lib/types/farm.ts` - New: TypeScript interfaces for all domain models
- `src/lib/server/db/farms.ts` - New: Farm query layer (all tables)
- `src/lib/server/db/referents.ts` - New: Referent CRUD operations
- `src/lib/components/ui/FarmSelector.svelte` - New: Radio-style farm selector
- `src/lib/components/ui/EditableField.svelte` - New: Inline editing component
- `src/lib/components/ui/FarmCard.svelte` - New: Reusable card wrapper
- `src/lib/components/viz/PerformanceChart.svelte` - New: Bar chart (Actual vs Target)
- `src/lib/components/viz/StatCard.svelte` - New: Stat card component
- `src/routes/+page.server.ts` - Updated: Redirect to /dashboard
- `src/routes/+page.svelte` - Updated: Minimal redirect page
- `src/routes/dashboard/+page.server.ts` - New: SSR data loader (all farm data)
- `src/routes/dashboard/+page.svelte` - New: Main dashboard with 6 tabs
- `src/routes/api/farms/[uuid]/+server.ts` - New: GET/PATCH farm endpoint
- `src/routes/api/farms/[uuid]/referents/+server.ts` - New: PUT referent endpoint
- `src/routes/api/farms/[uuid]/location/+server.ts` - New: PATCH location endpoint

### Debug Log References
- Build/svelte-check blocked by Windows group policy (`spawn UNKNOWN`) - environment issue, not code

### Change Log
- Tasks 1-11 implemented in single pass
- Task 12 pending: requires `npm run dev` to validate (blocked by group policy in this terminal)

### Completion Notes
- All type errors resolved except `spawn UNKNOWN` (Windows group policy blocking esbuild)
- Performance chart uses pure CSS/SVG bars (no Chart.js dependency needed for now)
- Dashboard tab shows generic placeholders when no performance data exists (Rotorsoft API not yet configured)
