# Story 1.3: Farm Management Application - Full CRUD with Dashboard

## 1. Context

Create a comprehensive farm management application with full CRUD capabilities, replicating the Taipy legacy app's functionality and superior aesthetics. The application features a tabbed interface for organizing farm data (Dashboard, General Info, Referents, Services, Contracts, Location) with inline editing capabilities.

## 2. Acceptance Criteria

### Layout & Navigation

- [ ] **AC1**: Fixed sidebar (300px) with gradient background displays farm selector (radio-style cards)
- [ ] **AC2**: "Database Documentation" button at bottom of sidebar
- [ ] **AC3**: Main content area with tabbed interface (6 tabs: Dashboard, General, Referents, Services, Contracts, Location)
- [ ] **AC4**: Responsive layout collapses to single column on mobile

### Tab 1: Dashboard (Visualization)

- [ ] **AC5**: Performance chart showing Actual vs Target by year (line chart)
- [ ] **AC6**: Stat cards displaying: Turbine Count, Total Power Capacity, Farm Status
- [ ] **AC7**: Data fetched from `get_farm_performance_data()` and `get_farm_technical_details()`

### Tab 2: General (Editable)

- [ ] **AC8**: Display fields: SPV, Project Name, Farm Code (read-only), Farm Type, Farm Status
- [ ] **AC9**: Inline editing with "Edit" button → Input field → Save/Cancel actions
- [ ] **AC10**: Updates persist to database via API routes

### Tab 3: Referents (Editable)

- [ ] **AC11**: Display key roles: Technical Manager, KAM, Head of Tech, Electrical Manager, Field Crew, Asset Manager
- [ ] **AC12**: Inline editing with person selector dropdown
- [ ] **AC13**: "Add New Person" functionality within edit mode

### Tab 4: Services

- [ ] **AC14**: Display service providers: OM Main, WTG Service, Grid Operator, Energy Trader, etc.
- [ ] **AC15**: Read-only display (editing to be added in future story)

### Tab 5: Contracts & Admin

- [ ] **AC16**: Display administration data: SIRET, VAT, Legal Rep, Head Office
- [ ] **AC17**: Display contracts: O&M Contract, TCMA Contract details
- [ ] **AC18**: Display financial guarantee, electrical delegation, environmental installation

### Tab 6: Location (Editable)

- [ ] **AC19**: Display geographic location: Country, Region, Department, Municipality
- [ ] **AC20**: Display distances: Arras distance, Vertou duration, tolls
- [ ] **AC21**: Inline editing for all location fields

### Aesthetics (Taipy-Inspired)

- [ ] **AC22**: Primary color blue `#1565c0` for accents, borders, buttons
- [ ] **AC23**: Gradient background for sidebar: `linear-gradient(180deg, #f8f9fa 0%, #e9ecef 100%)`
- [ ] **AC24**: Card-based layout with `bg-gray-50`, `8px` border-radius, subtle shadows
- [ ] **AC25**: Clean typography hierarchy: section titles, muted labels (#6c757d), bold values

### API & Data Layer

- [ ] **AC26**: Server-side loaders in `+page.server.ts` fetch all farm data
- [ ] **AC27**: API routes implement CRUD operations: `GET/PATCH /api/farms/[uuid]`, `PUT /api/farms/[uuid]/referents/[role]`
- [ ] **AC28**: Database query layer in `src/lib/server/db/` with TypeScript interfaces

## 3. Technical Notes

- Replicate Taipy app's inline editing pattern: toggle between display/edit modes
- Use Tailwind CSS for styling with custom CSS variables for Taipy color palette
- Extract SQL queries from Python `database.py` functions and adapt for Supabase
- Create reusable components: `FarmCard.svelte`, `EditableField.svelte`, `FarmSelector.svelte`
- Performance data visualization using Chart.js or similar lightweight library
- All database interactions must use SSR (server-side rendering) to keep credentials private

## 4. Tasks

- [ ] **Task 1: Project Setup & Styling**
  - [ ] Add Taipy color palette to `app.css` (CSS variables)
  - [ ] Create global styles for cards, gradients, scrollbars
  - [ ] Set up TypeScript interfaces in `src/lib/types/farm.ts`

- [ ] **Task 2: Database Query Layer**
  - [ ] Create `src/lib/server/db/farms.ts` with query functions
  - [ ] Create `src/lib/server/db/referents.ts` for referent operations
  - [ ] Port SQL logic from Python `database.py` to TypeScript/Supabase

- [ ] **Task 3: Shared UI Components**
  - [ ] Build `FarmCard.svelte` (reusable card component)
  - [ ] Build `EditableField.svelte` (inline editing component)
  - [ ] Build `FarmSelector.svelte` (radio-style farm selector)

- [ ] **Task 4: Dashboard Route - Layout & Sidebar**
  - [ ] Create `src/routes/dashboard/+page.server.ts` with data loaders
  - [ ] Create `src/routes/dashboard/+page.svelte` with 2-column layout
  - [ ] Implement sidebar with farm selector and logout button

- [ ] **Task 5: Tab 1 - Dashboard (Visualization)**
  - [ ] Fetch performance data in server loader
  - [ ] Create performance chart component (Actual vs Target)
  - [ ] Create stat cards for turbine count, power, status

- [ ] **Task 6: Tab 2 - General Info (Editable)**
  - [ ] Display general info fields with `EditableField` components
  - [ ] Implement inline editing for SPV, Project, Farm Type
  - [ ] Connect to PATCH API route for updates

- [ ] **Task 7: Tab 3 - Referents (Editable)**
  - [ ] Display referent roles in 2-column layout
  - [ ] Implement inline editing with person selector
  - [ ] Add "New Person" creation functionality

- [ ] **Task 8: Tab 4 - Services (Read-Only)**
  - [ ] Display service providers in card layout
  - [ ] Fetch company roles data in server loader

- [ ] **Task 9: Tab 5 - Contracts & Admin (Read-Only)**
  - [ ] Display administration data
  - [ ] Display O&M and TCMA contract details
  - [ ] Display financial, electrical, environmental sections

- [ ] **Task 10: Tab 6 - Location (Editable)**
  - [ ] Display location fields with `EditableField` components
  - [ ] Implement inline editing for all location data
  - [ ] Connect to PATCH API route for updates

- [ ] **Task 11: API Routes**
  - [ ] Create `GET/PATCH /api/farms/[uuid]/+server.ts`
  - [ ] Create `PUT /api/farms/[uuid]/referents/[role]/+server.ts`
  - [ ] Add Zod validation for all mutations

- [ ] **Task 12: Testing & Verification**
  - [ ] Test all CRUD operations (create, read, update for each tab)
  - [ ] Verify HMR works (changes reflect immediately)
  - [ ] Test responsive layout on mobile/tablet
  - [ ] Verify Taipy aesthetics match design spec
