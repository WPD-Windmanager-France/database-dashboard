# Story 1.4: Implement B2 API CRUD Endpoints

## Status
InProgress

## Story
**As a** Frontend Developer,
**I want** a comprehensive set of secure REST API endpoints to manage wind farm data,
**so that** I can build the user-facing management features.

---

## Acceptance Criteria

*   **AC1:** API endpoints for **CRUD** operations on "Farms" are created:
    *   `GET /farms`: Returns a list of all farms.
    *   `GET /farms/{uuid}`: Returns a single farm by its UUID.
    *   `POST /farms`: Creates a new farm.
    *   `PUT /farms/{uuid}`: Updates an existing farm.
    *   `DELETE /farms/{uuid}`: Deletes a farm.
*   **AC2:** All endpoints are protected by the Entra ID authentication middleware created in Story 1.2.
*   **AC3:** Input data for `POST` and `PUT` requests is validated (e.g., checking for required fields).
*   **AC4:** The API returns appropriate HTTP status codes (e.g., `200` OK, `201` Created, `400` Bad Request, `404` Not Found).
*   **AC5:** The logic for data extraction, aggregation, or specific calculations required by **B2 competencies (C8, C9, C10)** is implemented within these endpoints where applicable.
*   **AC6:** The API endpoints are documented using OpenAPI standards, and the documentation is accessible via a specific route (e.g., `/docs`).

---

## Tasks / Subtasks

- [x] **Task 1: Create farms CRUD routes** (AC1, AC4)
  - [x] Create `src/routes/farms.ts` with Hono router
  - [x] Implement `GET /farms` - list all farms with farm_type join
  - [x] Implement `GET /farms/:uuid` - get single farm with related data
  - [x] Implement `POST /farms` - create new farm
  - [x] Implement `PUT /farms/:uuid` - update existing farm
  - [x] Implement `DELETE /farms/:uuid` - delete farm

- [x] **Task 2: Add input validation** (AC3)
  - [x] Create validation schema for farm data
  - [x] Validate required fields: spv, project, code, farm_type_id
  - [x] Return 400 Bad Request with validation errors

- [x] **Task 3: Protect routes with auth middleware** (AC2)
  - [x] Apply authMiddleware to all /farms routes
  - [x] Test 401 response for unauthenticated requests

- [x] **Task 4: Implement B2 data aggregation endpoints** (AC5)
  - [x] `GET /farms/:uuid/summary` - aggregated farm data (C8, C10)
  - [x] `GET /farms/stats` - global statistics (C9, C10)
  - [x] Include turbine counts, performance data, etc.

- [x] **Task 5: Add OpenAPI documentation** (AC6)
  - [x] Install @hono/swagger-ui middleware
  - [x] Document all current endpoints with schemas
  - [x] Expose `/docs` route for Swagger UI
  - [ ] Update documentation as new routes are added

- [x] **Task 6: Update main router and documentation**
  - [x] Mount farms routes in index.ts
  - [x] Update README with new endpoints

---

## Dev Notes

### Database Schema (farms table)
```
farms:
  uuid: NVARCHAR(36) PK
  spv: NVARCHAR(100) NOT NULL
  project: NVARCHAR(100) NOT NULL
  code: NVARCHAR(10) NOT NULL UNIQUE
  farm_type_id: INT NOT NULL FK → farm_types(id)
```

### Related Tables for Aggregation
- farm_types (Wind/Solar/Hybrid)
- farm_turbine_details (turbine count, power)
- farm_statuses (farm_status, tcma_status)
- farm_locations (country, region, department)
- substations, wind_turbine_generators

### B2 Competencies
- **C8**: Data extraction from database ✓
- **C9**: SQL queries with joins, filters ✓
- **C10**: Aggregation and calculations ✓

---

## Testing

- **Manual Testing**: Test all CRUD operations via curl
- **Validation**: Test input validation with invalid data
- **Auth**: Test protected routes without token

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-03 | 1.0 | Initial story creation | PM |
| 2026-02-04 | 1.1 | Added detailed tasks | Dev Agent |
| 2026-02-04 | 1.2 | CRUD + B2 aggregation implemented, OpenAPI pending | Dev Agent |
| 2026-02-04 | 1.3 | OpenAPI 3.0 documentation added with Swagger UI | Dev Agent |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
- Supabase types simplifiés avec `any` pour flexibilité (typage strict possible via `supabase gen types`)
- Farm table utilise `uuid` (pas `id`) comme primary key
- Routes protégées via authMiddleware() dans index.ts

### Completion Notes List
- Task 1: CRUD complet sur /farms avec proper HTTP status codes
- Task 2: Validation avec validateFarmInput(), retourne 400 + details
- Task 3: Routes protégées, 401 confirmé sans token
- Task 4: /farms/stats et /farms/:uuid/summary pour B2 (C8, C9, C10)
- Task 5: OpenAPI 3.0 spec créée avec @hono/swagger-ui, accessible sur /docs
- Task 6: Routes montées dans index.ts et dev-server.ts, README mis à jour

### File List
- `backend/src/routes/farms.ts` - CRUD + aggregation endpoints
- `backend/src/openapi.ts` - OpenAPI 3.0 specification (WPD Windmanager France API)
- `backend/src/index.ts` - Import et montage routes farms + OpenAPI
- `backend/src/dev-server.ts` - Import et montage routes farms + OpenAPI
- `backend/src/lib/supabase.ts` - Types Farm ajoutés
- `backend/README.md` - Documentation endpoints mise à jour

---

## QA Results
*To be filled after implementation*
