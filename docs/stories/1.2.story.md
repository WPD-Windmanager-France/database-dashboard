# Story 1.2: Universal Authentication Strategy

**Epic**: WNDMNGR Modernization
**Status**: Ready for Review
**Points**: 5

## Story Statement
**As a** User,
**I want** to log in securely using the existing Supabase authentication for deployed versions and SQLite for local development,
**so that** my access is managed effectively during the migration and immediate operational needs are met. (Microsoft Entra ID will be addressed in a future story).

## Context & Background
Currently, `auth.py` contains mixed logic for Supabase and SQLite. We need to refactor this into a clean "Strategy Pattern" to manage authentication providers. We are also moving from Streamlit `st.session_state` to Taipy's state management. For this MVP, we will focus on porting the existing Supabase and SQLite authentication.

## Acceptance Criteria
1.  **Auth Architecture**: An abstract `AuthProvider` class is defined.
2.  **Providers Implemented**:
    *   `LocalProvider`: Replicates existing SQLite auth (email/pass check against `profiles` table).
    *   `SupabaseProvider`: Replicates existing Supabase auth (using `supabase-py`).
    *   `EntraIDProvider`: (DEFERRED for this story - will be a placeholder/stub).
3.  **Configuration**: The active provider is selected based on `settings.AUTH_TYPE` (e.g., "supabase", "local").
4.  **State Management**: Auth state (user, role, token) is stored in Taipy's `state` object, not `st.session_state`.
5.  **Role Management**: All active providers must return a standardized User object containing the role (`admin`, `user`, `viewer`).

## Technical Details

### Architecture Alignment
*   **Tech Stack**: [Source: docs/architecture/tech-stack.md]
    *   `supabase-py` for Supabase Auth.
*   **File Structure**: [Source: docs/architecture/source-tree.md]
    *   New file: `src/auth/provider.py` (Abstract Base Class).
    *   New file: `src/auth/local_auth.py`.
    *   New file: `src/auth/supabase_auth.py`.
    *   New file: `src/auth/entra_auth.py` (Placeholder).
    *   New file: `src/auth/manager.py` (Factory/Manager to select provider).

### MSAL / Entra ID Specs
*   **DEFERRED for this story.** The `entra_auth.py` file will be created but contain a basic "Not Implemented" placeholder. `msal` will not be added to `requirements.txt` in this story.

### Legacy Code Migration
*   Existing `login_user_sqlite` -> `LocalProvider.login()`.
*   Existing `login_user_supabase` -> `SupabaseProvider.login()`.
*   Existing `check_role` -> Moved to `AuthManager.check_permission()`.

## Tasks
1.  [x] Create `src/auth/` directory.
2.  [x] Define `AuthProvider` abstract base class in `provider.py` (methods: `login`, `logout`, `get_user`, `refresh`).
3.  [x] Implement `LocalProvider` in `local_auth.py` (porting logic from `auth.py`).
4.  [x] Implement `SupabaseProvider` in `supabase_auth.py` (porting logic from `auth.py`).
5.  [x] Create `entra_auth.py` with a placeholder/stub implementation (e.g., raise `NotImplementedError`).
6.  [x] Create `AuthManager` in `manager.py` to instantiate the correct provider based on `settings`.
7.  [x] Create a simple Taipy page `pages/login.py` to test `AuthManager` with Local and Supabase providers.
8.  [x] Update `requirements.txt` with `supabase-py` (if not already there) and `sqlalchemy` (if not already there and used by local auth).
9.  [x] Unit Test: Verify `LocalProvider` works with the existing SQLite DB.
10. [x] Unit Test: Verify `SupabaseProvider` works (if credentials available).

## Testing Requirements
*   **Local Test**: Set `AUTH_TYPE="local"` in `settings.toml`, run app, try logging in with `test@wpd.fr`.
*   **Supabase Test**: Set `AUTH_TYPE="supabase"` in `settings.toml`, try logging in (if creds available).
*   **Structure Test**: Ensure `AuthManager` loads the correct class.

## Dev Agent Record

### File List
*   `src/auth/__init__.py` (Created)
*   `src/auth/provider.py` (Created)
*   `src/auth/local_auth.py` (Created)
*   `src/auth/supabase_auth.py` (Created)
*   `src/auth/entra_auth.py` (Created)
*   `src/auth/manager.py` (Created)
*   `src/data/__init__.py` (Created)
*   `src/data/sqlite_db.py` (Created - Taipy-compatible, no Streamlit)
*   `src/data/supabase_db.py` (Created - Taipy-compatible, no Streamlit)
*   `pages/__init__.py` (Created)
*   `pages/login.py` (Created)
*   `settings.toml` (Modified - added AUTH_TYPE, db_path)
*   `TESTS/test_local_auth.py` (Created/Fixed)
*   `TESTS/test_supabase_auth.py` (Created/Fixed)

### Completion Notes
*   Implemented AuthProvider interface and concrete Local/Supabase providers.
*   Entra ID implementation deferred as per user's instruction.
*   AuthManager centralizes provider selection based on `settings.AUTH_TYPE`.
*   Basic Taipy login page created for testing.
*   Unit tests created for both Local and Supabase providers.
*   `auth.py` is still the legacy Streamlit auth, will be replaced in future stories.
*   **[FIX]** Added `AUTH_TYPE` and `db_path` to `settings.toml` (was missing).
*   **[FIX]** Created `src/data/` with Taipy-compatible versions of sqlite_db.py and supabase_db.py (no Streamlit dependencies).
*   **[FIX]** Fixed test mocking paths to correctly patch at usage location.
