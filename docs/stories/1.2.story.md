# Story 1.2: Implement Entra ID Authentication

## Status
Ready for Review

## Story
**As a** User,
**I want** to log in securely using my Microsoft Entra ID credentials,
**so that** the API can identify me and apply the correct permissions.

---

## Acceptance Criteria

1. **AC1:** The `msal-node` library is added as a dependency to the Cloudflare Worker project.
2. **AC2:** Configuration for Entra ID (Client ID, Tenant ID, Client Secret) is managed via Cloudflare Worker secrets/environment variables.
3. **AC3:** An endpoint (e.g., `/login`) is created to initiate the OAuth 2.0 Authorization Code Flow.
4. **AC4:** An endpoint (e.g., `/auth/callback`) is created to handle the redirect from Azure, exchange the authorization code for an access token, and validate it.
5. **AC5:** A middleware function is created in Hono to protect specific API routes, checking for a valid JWT in the `Authorization` header.
6. **AC6:** A protected endpoint (e.g., `/me`) is created that returns the authenticated user's information from their token.
7. **AC7:** Unauthenticated requests to protected endpoints receive a `401 Unauthorized` error.

---

## Tasks / Subtasks

- [x] **Task 1: Install authentication dependencies** (AC1)
  - [x] ~~Install `@azure/msal-node` for Entra ID OAuth~~ → Utilisation de `jose` + OAuth manuel (msal-node incompatible Workers Edge)
  - [x] Install `jose` for JWT validation (lightweight, Edge-compatible)
  - [x] Verify dependencies work with Cloudflare Workers runtime

- [x] **Task 2: Configure Entra ID environment** (AC2)
  - [x] Create `src/config/auth.ts` for auth configuration
  - [x] Define environment variable types in `wrangler.toml`
  - [x] Document required secrets: `AZURE_CLIENT_ID`, `AZURE_TENANT_ID`, `AZURE_CLIENT_SECRET`

- [x] **Task 3: Implement OAuth login flow** (AC3, AC4)
  - [x] Create `/auth/login` endpoint to generate authorization URL
  - [x] Create `/auth/callback` endpoint to handle Azure redirect
  - [x] Exchange authorization code for tokens
  - [x] Store/return tokens appropriately

- [x] **Task 4: Create JWT validation middleware** (AC5, AC7)
  - [x] Create `src/middleware/auth.ts` with Hono middleware
  - [x] Validate JWT signature using Entra ID public keys (JWKS)
  - [x] Extract user claims from token
  - [x] Return 401 for invalid/missing tokens

- [x] **Task 5: Create protected /me endpoint** (AC6)
  - [x] Create GET `/me` route protected by auth middleware
  - [x] Return user info: id, email, name from token claims
  - [x] Test with valid and invalid tokens

- [x] **Task 6: Update documentation**
  - [x] Update `backend/README.md` with auth setup instructions
  - [x] Document Entra ID app registration requirements

---

## Dev Notes

### Entra ID OAuth 2.0 Flow
```
1. User visits /auth/login
2. Backend redirects to Azure login page
3. User authenticates with Microsoft
4. Azure redirects to /auth/callback with auth code
5. Backend exchanges code for access_token + id_token
6. Backend validates tokens and extracts user info
7. Subsequent requests use Bearer token in Authorization header
```

### Cloudflare Workers Considerations
- `msal-node` may have Node.js dependencies incompatible with Workers
- Alternative: Use `jose` library for JWT validation + manual OAuth flow
- JWKS endpoint: `https://login.microsoftonline.com/{tenant}/discovery/v2.0/keys`

### Environment Variables (wrangler.toml)
```toml
[vars]
ENTRA_TENANT_ID = "your-tenant-id"
ENTRA_CLIENT_ID = "your-client-id"

# Secrets (via wrangler secret put)
# ENTRA_CLIENT_SECRET
```

### JWT Validation
- Verify signature against Entra ID JWKS
- Check `iss` (issuer), `aud` (audience), `exp` (expiration)
- Extract claims: `oid` (user id), `email`, `name`

---

## Testing

- **Manual Testing**: Test OAuth flow with real Entra ID app registration
- **Unit Tests**: Mock JWT validation for middleware tests
- **Validation**: Test 401 response for unauthenticated requests

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-03 | 1.0 | Initial story creation | PM |
| 2026-02-04 | 1.1 | All tasks completed, code validated, documentation updated | Dev Agent |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
- `msal-node` incompatible avec Cloudflare Workers Edge runtime (dépendances Node.js)
- Alternative utilisée: `jose` pour validation JWT + OAuth 2.0 Authorization Code Flow manuel
- JWKS mis en cache pour éviter fetch à chaque requête

### Completion Notes List
- Task 1: `jose` v6.1.3 installé, msal-node abandonné (incompatible Edge)
- Task 2: Config auth avec interfaces TypeScript, secrets définis dans wrangler.toml
- Task 3: Routes `/auth/login`, `/auth/callback`, `/auth/logout` implémentées
- Task 4: Middleware authMiddleware() avec validation JWKS et extraction claims
- Task 5: Endpoint `/me` protégé, retourne id/email/name de l'utilisateur
- Task 6: README.md mis à jour avec documentation auth complète

### File List
- `backend/src/config/auth.ts` - Configuration Entra ID et endpoints
- `backend/src/middleware/auth.ts` - Middleware JWT validation
- `backend/src/routes/auth.ts` - Routes OAuth (login/callback/logout)
- `backend/src/index.ts` - Point d'entrée avec routes protégées
- `backend/wrangler.toml` - Variables d'environnement
- `backend/README.md` - Documentation mise à jour

---

## QA Results
*To be filled after implementation*
